@page "/imagen"

<AuthorizeView>
    <h3 style="margin-bottom:10px; text-align:center;">Escanear Facturas & Remitos X</h3>


<div class="card">
    <div class="row">
        <label>Google Vision API Key</label>
        <input type="text" @bind="GoogleApiKey" @bind:event="oninput" placeholder="API key de Google (Vision/Gemini)..." />
    </div>
    
    <div class="row">
        <label>Token Colector</label>
        <input type="text" @bind="ColectorToken" @bind:event="oninput" placeholder="Token Bearer para Colector..." />
    </div>
    
    <div class="row">
        <InputFile OnChange="OnFileSelected" accept=".png,.jpg,.jpeg,.bmp,.webp,.pdf" />
        <button class="btn" @onclick="RunOCR" disabled="@IsOcrLoading">
            @(IsOcrLoading ? "Procesando..." : "Procesar OCR")
        </button>
        <button class="btn btn-purple" @onclick="ExtraerProductosIA" disabled="@(!CanRunIA)">
            @(IsIaLoading ? "Extrayendo..." : "Extraer productos (IA)")
        </button>
    </div>

    @if (!string.IsNullOrWhiteSpace(Error))
    {
        <div class="alert error">@Error</div>
    }
    
    @if (MostrarMensajeExito)
    {
        <div class="alert success fadeInOut">@MensajeExito</div>
    }
    
    @if (MostrarConfirmacionImagen && !string.IsNullOrWhiteSpace(MensajeExito))
    {
        <div class="alert success fadeInOut">
            @MensajeExito
        </div>
    }
</div>

@if (!string.IsNullOrWhiteSpace(ImageDataUrl) || (ImageBytes != null && IsPdfFile))
{
    <div class="stage">
        <div class="img-wrap">
            @if (IsPdfFile)
            {
                <div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 10px; min-height: 400px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <div style="font-size: 64px; margin-bottom: 16px;">üìÑ</div>
                    <div style="font-weight: 600; color: #333; margin-bottom: 8px;">Archivo PDF cargado</div>
                    <div style="color: #666; font-size: 14px;">@NombreArchivoImagen</div>
                    <div style="color: #999; font-size: 12px; margin-top: 4px;">@Tama√±oArchivoImagen</div>
                </div>
            }
            else
            {
                <img id="ocr-img" src="@ImageDataUrl" @ref="ImgRef" @onload="OnImageLoaded" />
                <svg class="overlay" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; background: transparent; fill: none;">
                    @if (Polygons?.Count > 0)
                    {
                        @foreach (var p in Polygons)
                        {
                            <polygon points="@p.PointsAttr" class="poly"
                                     style="fill: rgba(255,0,0,0.15); stroke: #ef4444; stroke-width: 2; vector-effect: non-scaling-stroke; pointer-events: auto;"
                                     @onmouseover="@(() => HoverText = p.Text)" 
                                     @onmouseout="@(() => HoverText = null)"
                                     @onclick="@(() => CopyText(p.Text))">
                            </polygon>
                        }
                    }
                </svg>
            }
        </div>

        <div class="side">
@*             <div class="section">
                <div class="section-title">Proveedor</div>
                <textarea readonly rows="3">@(string.IsNullOrWhiteSpace(ProveedorExtraido) ? "Esperando extracci√≥n..." : ProveedorExtraido)</textarea>
            </div> *@

            <div class="section">
                <div class="section-title">Texto OCR</div>
                <textarea readonly rows="12">@FullOcrText</textarea>
            </div>

            @if (!string.IsNullOrWhiteSpace(TipoComprobanteDetectado))
            {
                <div class="section">
                    <div class="section-title">Tipo de comprobante detectado</div>
                    <div style="margin-top: 8px; padding: 12px; border-radius: 10px; border: 1px solid #cbd5f5; background: #eff6ff; color: #0f172a; display: flex; flex-direction: column; gap: 6px;">
                        <div style="font-size: 14px; font-weight: 600;">@TipoComprobanteDetectado</div>
                        <div style="font-size: 12px; color: #475569;">Identificado autom√°ticamente a partir del OCR y los datos IA.</div>
                    </div>
                </div>
            }

            <div class="section">
                <div class="section-title">Productos (IA)</div>
                <textarea readonly rows="12">@ProductosJson</textarea>
                <div style="margin-top: 16px; display: flex; flex-direction: column; gap: 12px; max-width: 100%;">
@*                     <button class="btn btn-green" 
                            @onclick="AbrirModalTipoOperacion" 
                            disabled="@(!CanSendToColector)"
                            style="width: 100%;">
                        ENVIAR AL COLECTOR
                    </button> *@
                    <button class="btn btn-orange" 
                            @onclick="MostrarProductosEnTabla" 
                            disabled="@string.IsNullOrWhiteSpace(ProductosJson)"
                            style="width: 100%;">
                        üìã VER PRODUCTOS EN TABLA
                    </button>
@*                     <button class="btn btn-blue" 
                            @onclick="ListarDatosColectados" 
                            disabled="@(IsListandoColector || string.IsNullOrWhiteSpace(ProductosJson))"
                            style="width: 100%;">
                        @(IsListandoColector ? "Listando..." : "üìã VER PRODUCTOS EN TABLA")
                    </button> *@
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(HoverText))
{
    <div class="tooltip-fixed">
        <div class="tooltip-title">Texto en √°rea</div>
        <div class="tooltip-body">@HoverText</div>
        <div class="tooltip-foot">Click para copiar</div>
    </div>
}

@if (MostrarModalTipoOperacion)
{
    <div class="app-modal-backdrop" @onclick="CerrarModalTipoOperacion">
        <div class="app-modal" @onclick:stopPropagation="true" @onkeydown="HandleKeyDown" tabindex="0">
            <div class="app-modal-header">
                <h3 class="app-modal-title">‚öôÔ∏è Seleccionar Tipo de Operaci√≥n</h3>
                <button class="app-modal-close" @onclick="CerrarModalTipoOperacion">√ó</button>
            </div>
            
            <div class="app-modal-body">
                <div style="margin-bottom: 20px;">
                    <p style="margin-bottom: 16px; color: #666;">
                        Selecciona el tipo de operaci√≥n para enviar los datos al Colector:
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        @foreach (var tipo in TiposOperacion)
                        {
                            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; @(TipoOperacionTemporal == tipo.Id ? "background-color: #e3f2fd; border-color: #2196f3;" : "")" 
                                   @onclick="@(async () => await SeleccionarTipoOperacion(tipo.Id, tipo.Nombre))">
                                <input type="radio" 
                                       name="tipoOperacion" 
                                       value="@tipo.Id" 
                                       checked="@(TipoOperacionTemporal == tipo.Id)"
                                       style="margin-right: 12px; transform: scale(1.2);" />
                                <div>
                                    <div style="font-weight: 600; color: #333;">@tipo.Nombre</div>
                                    <div style="font-size: 12px; color: #666;">ID: @tipo.Id</div>
                                </div>
                            </label>
                        }
                    </div>
                </div>
            </div>
            
            <div class="app-modal-footer">
                <button class="btn btn-gray" @onclick="CerrarModalTipoOperacion" disabled="@IsColectorLoading">
                    Cancelar
                </button>
                <button class="btn btn-green" @onclick="ConfirmarTipoOperacion" disabled="@IsColectorLoading">
                    @(IsColectorLoading ? "‚è≥ Enviando..." : "‚úÖ Enviar al Colector")
                </button>
            </div>
        </div>
    </div>
}

@if (MostrarModalColector)
{
    <div class="app-modal-backdrop" @onclick="CerrarModalColector">
        <div class="app-modal app-modal-xl" @onclick:stopPropagation="true" @onkeydown="HandleKeyDown" tabindex="0" @ref="ModalRef">
            <div class="app-modal-header">
                <h3 class="app-modal-title">üìã @(ProductosExtraidos != null ? "Productos Extra√≠dos con IA" : "Datos del Colector")</h3>
                <button class="app-modal-close" @onclick="CerrarModalColector">√ó</button>
            </div>
            
            <div class="app-modal-body">
                @if (ProductosExtraidos != null || (ColectorDatos != null && ColectorDatos.Any()) || !string.IsNullOrWhiteSpace(DatosColectorModal))
                {
                        @if (ProductosExtraidos != null)
                        {
                            <div style="margin-bottom: 16px;">
                                <strong>‚úÖ Productos extra√≠dos con IA</strong>
                                
                                @* Mostrar datos de encabezado *@
                                @if (ProductosExtraidos.Encabezado != null)
                                {
                                    <div style="margin-top: 8px; padding: 12px; background: #e3f2fd; border-radius: 8px; border: 1px solid #90caf9;">
                                        <strong style="color: #333; font-size: 14px;">üìã Encabezado del Comprobante:</strong>
                                        <div style="margin-top: 4px; color: #666; font-size: 13px;">
                                            @if (!string.IsNullOrWhiteSpace(ProductosExtraidos.Encabezado.TipoComprobante))
                                            {
                                                <div><strong>Tipo:</strong> @ProductosExtraidos.Encabezado.TipoComprobante</div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(ProductosExtraidos.Encabezado.NumeroComprobante))
                                            {
                                                <div><strong>N√∫mero:</strong> @ProductosExtraidos.Encabezado.NumeroComprobante</div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(ProductosExtraidos.Encabezado.Talonario))
                                            {
                                                <div><strong>Talonario:</strong> @ProductosExtraidos.Encabezado.Talonario</div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(ProductosExtraidos.Encabezado.FechaComprobante))
                                            {
                                                <div><strong>Fecha:</strong> @ProductosExtraidos.Encabezado.FechaComprobante</div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(ProductosExtraidos.Encabezado.Subtotal))
                                            {
                                                <div><strong>Subtotal:</strong> @ProductosExtraidos.Encabezado.Subtotal</div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(ProductosExtraidos.Encabezado.Total))
                                            {
                                                <div><strong>Total:</strong> @ProductosExtraidos.Encabezado.Total</div>
                                            }
                                        </div>

                                        @if (ProductosExtraidos.Encabezado.ImpuestosAplicados != null && ProductosExtraidos.Encabezado.ImpuestosAplicados.Any(i => !string.IsNullOrWhiteSpace(i?.Nombre) || !string.IsNullOrWhiteSpace(i?.Monto)))
                                        {
                                            <div style="margin-top: 10px; padding: 10px; border-radius: 8px; background: #fff; border: 1px dashed #90caf9;">
                                                <div style="font-weight: 600; color: #1d4ed8; margin-bottom: 6px;">Impuestos / Recargos:</div>
                                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                                    @foreach (var impuesto in ProductosExtraidos.Encabezado.ImpuestosAplicados)
                                                    {
                                                        if (impuesto == null || (string.IsNullOrWhiteSpace(impuesto.Nombre) && string.IsNullOrWhiteSpace(impuesto.Monto)))
                                                        {
                                                            continue;
                                                        }

                                                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #1e293b; border: 1px solid #e0e7ff; border-radius: 6px; padding: 6px 10px; background: #f8fafc;">
                                                            <span style="font-weight: 600;">@(impuesto.Nombre ?? "Impuesto")</span>
                                                            <span>@(impuesto.Monto ?? "-")</span>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                
                                @* Mostrar datos del proveedor *@
                                @if (ProductosExtraidos.Proveedor != null)
                                {
                                    <div style="margin-top: 8px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e1e5e9;">
                                        <strong style="color: #333; font-size: 14px;">üè¢ Proveedor:</strong>
                                        <div style="margin-top: 4px; color: #666; font-size: 13px;">
                                            <div><strong>Raz√≥n Social:</strong> @(ProductosExtraidos.Proveedor.RazonSocial ?? "-")</div>
                                            <div><strong>CUIT/CUIL:</strong> @(ProductosExtraidos.Proveedor.CuitCuil ?? "-")</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        
                        @if (ProductosExtraidos.Productos != null && ProductosExtraidos.Productos.Any())
                        {
                            var productosOrdenados = ProductosExtraidos.Productos
                                .OrderBy(p => p.Orden ?? int.MaxValue)
                                .ToList();
                            
                            var mostrarColumnaDescuento = productosOrdenados.Any(p =>
                                !string.IsNullOrWhiteSpace(p.Descuento));

                            <div style="max-height: 500px; overflow-y: auto;">
                                <div style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 16px; background: #fff;">
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                            <thead>
                                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                    <th style="padding: 10px; text-align: center; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 50px;">#</th>
                                                    <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">C√≥digo</th>
                                                    <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">Descripci√≥n</th>
                                                    <th style="padding: 10px; text-align: right; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">Cantidad</th>
                                                    <th style="padding: 10px; text-align: right; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">Precio Unit.</th>
                                                    <th style="padding: 10px; text-align: center; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">IVA</th>
                                                    @if (mostrarColumnaDescuento)
                                                    {
                                                        <th style="padding: 10px; text-align: center; font-weight: 600; color: #495057;">Descuento</th>
                                                    }
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var producto in productosOrdenados)
                                                {
                                                    <tr style="border-bottom: 1px solid #e9ecef;">
                                                        <td style="padding: 10px; border-right: 1px solid #e9ecef; text-align: center; color: #666; font-weight: 600;">
                                                            @(producto.Orden?.ToString() ?? "-")
                                                        </td>
                                                        <td style="padding: 10px; border-right: 1px solid #e9ecef; color: #333; font-family: 'Courier New', monospace;">
                                                            @(producto.Codigo ?? "-")
                                                        </td>
                                                        <td style="padding: 10px; border-right: 1px solid #e9ecef; color: #333; max-width: 300px; word-wrap: break-word;">
                                                            @(producto.Descripcion ?? "-")
                                                        </td>
                                                        <td style="padding: 10px; border-right: 1px solid #e9ecef; text-align: right; color: #333; font-weight: 500;">
                                                            @(producto.Cantidad ?? "-")
                                                        </td>
                                                        <td style="padding: 10px; border-right: 1px solid #e9ecef; text-align: right; color: #333; font-weight: 500;">
                                                            @(producto.PrecioUnitario ?? "-")
                                                        </td>
                                                        <td style="padding: 10px; border-right: 1px solid #e9ecef; text-align: center; color: #333;">
                                                            @if (!string.IsNullOrWhiteSpace(producto.IvaPorcentaje))
                                                            {
                                                                <span style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; font-weight: 500;">@producto.IvaPorcentaje%</span>
                                                            }
                                                            else
                                                            {
                                                                <span style="color: #999;">-</span>
                                                            }
                                                        </td>
                                                    @if (mostrarColumnaDescuento)
                                                    {
                                                        if (!string.IsNullOrWhiteSpace(producto.Descuento))
                                                        {
                                                            <td style="padding: 10px; text-align: center; color: #333;">
                                                                <span style="background: #d1e7dd; padding: 4px 8px; border-radius: 4px; font-weight: 500;">@producto.Descuento</span>
                                                            </td>
                                                        }
                                                        else
                                                        {
                                                            <td style="padding: 10px; text-align: center; color: #999;">‚Äî</td>
                                                        }
                                                    }
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div style="text-align: center; color: #666; padding: 20px;">
                                No hay productos para mostrar
                            </div>
                        }
                    }
                    else if (ColectorDatos != null && ColectorDatos.Any())
                    {
                        <div style="margin-bottom: 16px;">
                            <strong>‚úÖ Datos obtenidos exitosamente del servidor</strong>
                            <br />
                            <small style="color: #666;">
                                Los datos se copiaron autom√°ticamente al portapapeles
                            </small>
                        </div>
                        
                        <div style="max-height: 500px; overflow-y: auto;">
                            @foreach (var encabezado in ColectorDatos)
                            {
                                <div style="margin-bottom: 24px; border: 1px solid #e1e5e9; border-radius: 8px; padding: 16px; background: #fff;">
                                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #e1e5e9;">
                                        <strong style="color: #333; font-size: 14px;">üìã Encabezado ID: @encabezado.ColectorEncabID</strong>
                                        @if (!string.IsNullOrWhiteSpace(encabezado.FechaHora))
                                        {
                                            <div style="color: #666; font-size: 12px; margin-top: 4px;">
                                                üìÖ Fecha/Hora: @encabezado.FechaHora
                                            </div>
                                        }
                                    </div>
                                    
                                    @if (encabezado.ColectorItem != null && encabezado.ColectorItem.Any())
                                    {
                                        <div style="overflow-x: auto;">
                                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                                <thead>
                                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                        <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">C√≥digo ID</th>
                                                        <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">Rubro</th>
                                                        <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">Descripci√≥n</th>
                                                        <th style="padding: 10px; text-align: right; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">Cantidad</th>
                                                        <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">C√≥digo Barra</th>
                                                        <th style="padding: 10px; text-align: right; font-weight: 600; color: #495057;">Piezas</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in encabezado.ColectorItem)
                                                    {
                                                        <tr style="border-bottom: 1px solid #e9ecef;">
                                                            <td style="padding: 10px; border-right: 1px solid #e9ecef; color: #333;">
                                                                @(item.Producto?.CodigoID ?? item.codigoID)
                                                            </td>
                                                            <td style="padding: 10px; border-right: 1px solid #e9ecef; color: #666;">
                                                                @(item.Producto?.RubroCodigo ?? "-")
                                                            </td>
                                                            <td style="padding: 10px; border-right: 1px solid #e9ecef; color: #333; max-width: 300px; word-wrap: break-word;">
                                                                @(item.Producto?.DescripcionLarga ?? item.Producto?.Descripcion ?? item.descripcion ?? "-")
                                                            </td>
                                                            <td style="padding: 10px; border-right: 1px solid #e9ecef; text-align: right; color: #333; font-weight: 500;">
                                                                @item.cantidad.ToString("N2")
                                                            </td>
                                                            <td style="padding: 10px; border-right: 1px solid #e9ecef; color: #666; font-family: 'Courier New', monospace; font-size: 11px;">
                                                                @(item.codigoBarra ?? "-")
                                                            </td>
                                                            <td style="padding: 10px; text-align: right; color: #333; font-weight: 500;">
                                                                @item.cantidadPiezas
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <div style="text-align: center; color: #666; padding: 20px;">
                                            No hay items en este encabezado
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div style="background: #f8f9fa; border: 1px solid #e1e5e9; border-radius: 8px; padding: 16px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap;">
                            @DatosColectorModal
                        </div>
                    }
                }
                else
                {
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                        <div>No hay datos para mostrar</div>
                    </div>
                }
            </div>
            
            <div class="app-modal-footer">
                <button class="btn btn-gray" @onclick="CerrarModalColector">
                    Cerrar
                </button>
                <button class="btn btn-blue" @onclick="CopiarDatosColector" disabled="@string.IsNullOrWhiteSpace(DatosColectorModal)">
                    üìã Copiar Datos
                </button>
            </div>
        </div>
    </div>
}
</AuthorizeView>

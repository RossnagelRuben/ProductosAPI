<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BlazorApp_ProductosAPI</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="css/app.modal.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="ICO.ico" />
    <link href="BlazorApp_ProductosAPI.styles.css" rel="stylesheet" />
    <link href="manifest.json" rel="manifest" />
    <link rel="apple-touch-icon" href="ICO.ico" />
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">üóô</a>
    </div>
    <!-- Funciones cr√≠ticas para Imagen.razor - deben estar antes de Blazor -->
    <script>
        // Funciones para Imagen.razor - OCR y overlay SVG
        // Definir inmediatamente para que est√©n disponibles cuando Blazor las necesite
        window.getImageSizes = function(selector) {
            try {
                const img = document.querySelector(selector);
                if (!img) {
                    console.warn(`No se encontr√≥ imagen con selector: ${selector}`);
                    return {
                        clientWidth: 0,
                        clientHeight: 0,
                        naturalWidth: 0,
                        naturalHeight: 0
                    };
                }
                
                return {
                    clientWidth: img.clientWidth || 0,
                    clientHeight: img.clientHeight || 0,
                    naturalWidth: img.naturalWidth || 0,
                    naturalHeight: img.naturalHeight || 0
                };
            } catch (error) {
                console.error('Error en getImageSizes:', error);
                return {
                    clientWidth: 0,
                    clientHeight: 0,
                    naturalWidth: 0,
                    naturalHeight: 0
                };
            }
        };

        window.sizeSvgOverImage = function(selector, clientW, clientH, naturalW, naturalH) {
            try {
                const svg = document.querySelector(selector);
                if (!svg) {
                    console.warn(`No se encontr√≥ SVG con selector: ${selector}`);
                    return;
                }
                
                // Asegurar que los valores sean v√°lidos
                if (!clientW || !clientH || !naturalW || !naturalH) {
                    console.warn('Dimensiones inv√°lidas para sizeSvgOverImage');
                    return;
                }
                
                svg.setAttribute('width', clientW);
                svg.setAttribute('height', clientH);
                svg.setAttribute('viewBox', `0 0 ${naturalW} ${naturalH}`);
                svg.setAttribute('preserveAspectRatio', 'none');
                
            } catch (error) {
                console.error('Error en sizeSvgOverImage:', error);
            }
        };

        // Log para diagn√≥stico de Asignar Im√°genes (F12 ‚Üí Consola)
        window.__logAsignarImagenes = function(tag, data) {
            try {
                var out = (typeof data === 'string' && (data.trim().startsWith('[') || data.trim().startsWith('{')))
                    ? JSON.parse(data)
                    : data;
                console.log('[AsignarImagenes] ' + tag, out);
            } catch (e) {
                console.log('[AsignarImagenes] ' + tag, data);
            }
        };

        // Descarga una imagen por URL y devuelve data URL (evita CORS/HttpClient en Blazor WASM)
        window.__fetchImageAsDataUrl = function(url) {
            return fetch(url, { mode: 'cors', credentials: 'omit' })
                .then(function(r) { if (!r.ok) return null; return r.blob(); })
                .then(function(blob) {
                    if (!blob) return null;
                    if (blob.type && blob.type.indexOf('pdf') !== -1) return null;
                    return new Promise(function(resolve, reject) {
                        var r = new FileReader();
                        r.onload = function() { resolve(r.result); };
                        r.onerror = reject;
                        r.readAsDataURL(blob);
                    });
                })
                .catch(function() { return null; });
        };
    </script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="js/dom.js"></script>
    <script src="js/modalHelper.js"></script>
    
    <!-- QR Scanner Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-reader/1.0.0/qrcode-reader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    
    <script>
        // Registrar SW solo fuera de localhost para evitar ruido en desarrollo
        if (!location.hostname.includes('localhost')) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</body>

</html>

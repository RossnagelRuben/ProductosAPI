<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BlazorApp_ProductosAPI</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="css/app.modal.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="ICO.ico" />
    <link href="BlazorApp_ProductosAPI.styles.css" rel="stylesheet" />
    <link href="manifest.json" rel="manifest" />
    <link rel="apple-touch-icon" href="ICO.ico" />
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">üóô</a>
    </div>
    <!-- Funciones cr√≠ticas para Imagen.razor - deben estar antes de Blazor -->
    <script>
        // Funciones para Imagen.razor - OCR y overlay SVG
        // Definir inmediatamente para que est√©n disponibles cuando Blazor las necesite
        window.getImageSizes = function(selector) {
            try {
                const img = document.querySelector(selector);
                if (!img) {
                    console.warn(`No se encontr√≥ imagen con selector: ${selector}`);
                    return {
                        clientWidth: 0,
                        clientHeight: 0,
                        naturalWidth: 0,
                        naturalHeight: 0
                    };
                }
                
                return {
                    clientWidth: img.clientWidth || 0,
                    clientHeight: img.clientHeight || 0,
                    naturalWidth: img.naturalWidth || 0,
                    naturalHeight: img.naturalHeight || 0
                };
            } catch (error) {
                console.error('Error en getImageSizes:', error);
                return {
                    clientWidth: 0,
                    clientHeight: 0,
                    naturalWidth: 0,
                    naturalHeight: 0
                };
            }
        };

        window.sizeSvgOverImage = function(selector, clientW, clientH, naturalW, naturalH) {
            try {
                const svg = document.querySelector(selector);
                if (!svg) {
                    console.warn(`No se encontr√≥ SVG con selector: ${selector}`);
                    return;
                }
                
                // Asegurar que los valores sean v√°lidos
                if (!clientW || !clientH || !naturalW || !naturalH) {
                    console.warn('Dimensiones inv√°lidas para sizeSvgOverImage');
                    return;
                }
                
                svg.setAttribute('width', clientW);
                svg.setAttribute('height', clientH);
                svg.setAttribute('viewBox', `0 0 ${naturalW} ${naturalH}`);
                svg.setAttribute('preserveAspectRatio', 'none');
                
            } catch (error) {
                console.error('Error en sizeSvgOverImage:', error);
            }
        };

        // Log para diagn√≥stico de Asignar Im√°genes (F12 ‚Üí Consola)
        window.__logAsignarImagenes = function(tag, data) {
            try {
                var out = (typeof data === 'string' && (data.trim().startsWith('[') || data.trim().startsWith('{')))
                    ? JSON.parse(data)
                    : data;
                console.log('[AsignarImagenes] ' + tag, out);
            } catch (e) {
                console.log('[AsignarImagenes] ' + tag, data);
            }
        };

        // Descarga una imagen por URL y devuelve data URL (evita CORS/HttpClient en Blazor WASM)
        window.__fetchImageAsDataUrl = function(url) {
            return fetch(url, { mode: 'cors', credentials: 'omit' })
                .then(function(r) { if (!r.ok) return null; return r.blob(); })
                .then(function(blob) {
                    if (!blob) return null;
                    if (blob.type && blob.type.indexOf('pdf') !== -1) return null;
                    return new Promise(function(resolve, reject) {
                        var r = new FileReader();
                        r.onload = function() { resolve(r.result); };
                        r.onerror = reject;
                        r.readAsDataURL(blob);
                    });
                })
                .catch(function() { return null; });
        };

        // Redimensiona/comprime una data URL de imagen para que pese menos sin perder calidad notable.
        // Devuelve una Promise<string> con una nueva data URL (JPEG) o la original si algo falla.
        window.__setObservacionesPreviewContent = function(id, html) {
            function set() {
                var el = document.getElementById(id);
                if (el) el.innerHTML = html || '';
            }
            if (typeof requestAnimationFrame !== 'undefined')
                requestAnimationFrame(function() { requestAnimationFrame(set); });
            else
                set();
        };
        window.__getObservacionesPreviewContent = function(id) {
            var el = document.getElementById(id);
            return el ? el.innerHTML : '';
        };
        window.__optimizarImagenAsignar = function(dataUrl, maxWidth, maxHeight, quality) {
            return new Promise(function(resolve, reject) {
                try {
                    if (!dataUrl || typeof dataUrl !== 'string' || dataUrl.indexOf('data:image/') !== 0) {
                        resolve(dataUrl);
                        return;
                    }

                    var img = new Image();
                    img.onload = function() {
                        try {
                            var w = img.naturalWidth || img.width;
                            var h = img.naturalHeight || img.height;
                            if (!w || !h) {
                                resolve(dataUrl);
                                return;
                            }

                            var maxW = (typeof maxWidth === 'number' && maxWidth > 0) ? maxWidth : 800;
                            var maxH = (typeof maxHeight === 'number' && maxHeight > 0) ? maxHeight : 800;
                            var ratio = Math.min(maxW / w, maxH / h, 1);

                            // Si ya es m√°s chica que el m√°ximo, no tocamos la imagen.
                            if (!isFinite(ratio) || ratio >= 1) {
                                resolve(dataUrl);
                                return;
                            }

                            var canvas = document.createElement('canvas');
                            canvas.width = Math.round(w * ratio);
                            canvas.height = Math.round(h * ratio);
                            var ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            var q = (typeof quality === 'number' && quality > 0 && quality <= 1) ? quality : 0.85;
                            var out = canvas.toDataURL('image/jpeg', q);
                            resolve(out || dataUrl);
                        } catch (e) {
                            console.error('Error en __optimizarImagenAsignar:', e);
                            resolve(dataUrl);
                        }
                    };
                    img.onerror = function() {
                        resolve(dataUrl);
                    };
                    img.src = dataUrl;
                } catch (e) {
                    console.error('Error en __optimizarImagenAsignar:', e);
                    resolve(dataUrl);
                }
            });
        };
    </script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="js/dom.js"></script>
    <script src="js/modalHelper.js"></script>
    
    <!-- QR Scanner Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-reader/1.0.0/qrcode-reader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    
    <script>
        // Registrar SW solo fuera de localhost para evitar ruido en desarrollo
        if (!location.hostname.includes('localhost')) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</body>

</html>
